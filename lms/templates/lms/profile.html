{% extends "lms/base.html" %}
{% block title %}Mi perfil ‚Äî Infinito Capacitaciones{% endblock %}

{% block content %}

<style>
  .profile-grid{display:grid;grid-template-columns:280px 1fr;gap:18px}
  .card{background:#fff;border:1px solid #e9e9e9;border-radius:16px;padding:16px;box-shadow:0 4px 10px rgba(0,0,0,.04)}
  .kpis{display:grid;grid-template-columns:repeat(4, minmax(0,1fr));gap:16px;margin-bottom:16px}
  .kpi{background:white;border:1px solid #eee;border-radius:14px;padding:16px;cursor:pointer;transition:transform .08s;display:flex;align-items:center;gap:12px}
  .kpi:hover{transform:translateY(-1px)}
  .kpi .num{font-weight:800;font-size:28px;line-height:1}
  .kpi .lbl{font-size:12px;opacity:.75}
  .kpi.badge-purple .dot{width:10px;height:10px;border-radius:50%;background:#a855f7}
  .kpi.badge-blue   .dot{width:10px;height:10px;border-radius:50%;background:#3b82f6}
  .kpi.badge-green  .dot{width:10px;height:10px;border-radius:50%;background:#22c55e}
  .kpi.badge-red    .dot{width:10px;height:10px;border-radius:50%;background:#ef4444}

  .avatar{width:140px;height:140px;border-radius:50%;border:8px solid #f8e8f5;object-fit:cover}
  .side-menu a{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:10px}
  .side-menu a.active, .side-menu a:hover{background:#fff;border:1px solid #f1c5eb}
  .btn{background:#ff4ec6;color:#fff;border:none;border-radius:999px;padding:10px 16px;font-weight:700;text-decoration:none}
  .btn.secondary{background:#fff;color:#ff4ec6;border:2px solid #ff4ec6}
  .chip{display:inline-flex;align-items:center;gap:8px;border:1px solid #eee;border-radius:999px;padding:6px 10px;background:#fff}
  .chip.ok{border-color:#22c55e;background:#eafaf1}
  .muted{opacity:.75}
  .course-card{border:1px solid #f5cfe9;background:#fff6fb;border-radius:14px;padding:14px}
  .header-row{display:flex;align-items:center;justify-content:space-between;margin:14px 0}
  .tabs{display:flex;gap:12px;margin:8px 0 14px}
  .tab{padding:8px 12px;border-radius:999px;border:1px solid #eee;background:#fff;cursor:pointer}
  .tab.active{background:#ff4ec6;color:white;border-color:#ff4ec6}
  .list{display:grid;gap:12px}
  .empty{padding:40px;text-align:center;border:1px dashed #ddd;border-radius:12px;background:#fff}
  .hidden{display:none}
</style>

<h1>Mi perfil</h1>

<!-- KPIs filtrables -->
<div class="kpis" id="kpiBar">
  <div class="kpi badge-purple" data-filter="todos" data-target="cursos" title="Ver todos">
    <div class="dot"></div>
    <div>
      <div class="num">{{ stats.inscriptos }}</div>
      <div class="lbl">Cursos inscriptos</div>
    </div>
  </div>
  <div class="kpi badge-blue" data-filter="en_progreso" data-target="cursos" title="Ver en progreso">
    <div class="dot"></div>
    <div>
      <div class="num">{{ stats.en_progreso }}</div>
      <div class="lbl">Cursos en progreso</div>
    </div>
  </div>
  <div class="kpi badge-green" data-filter="aprobado" data-target="cursos" title="Ver finalizados">
    <div class="dot"></div>
    <div>
      <div class="num">{{ stats.finalizados }}</div>
      <div class="lbl">Cursos finalizados</div>
    </div>
  </div>
  <div class="kpi badge-red" data-filter="desaprobados" data-target="cursos" title="Ver cuestionarios desaprobados">
    <div class="dot"></div>
    <div>
      <div class="num">{{ stats.desaprobados }}</div>
      <div class="lbl">Cuestionarios desaprobados</div>
    </div>
  </div>
</div>

<div class="profile-grid">
  <!-- LADO IZQUIERDO -->
  <div class="card">
    <div style="text-align:center">
      <img class="avatar" src="{{ avatar_url }}" alt="Avatar">
      <h3 style="margin:10px 0 2px">{{ request.user.username }}</h3>
      <div class="muted">{{ request.user.email }}</div>
    </div>

    <div class="side-menu" style="margin-top:16px;display:grid;gap:8px">
      <a href="#mis-cursos" data-panel="cursos" class="active">üìö Mis cursos</a>
      <a href="#pedidos" data-panel="pedidos">üßæ Pedidos</a>
      <a href="#config" data-panel="config">‚öôÔ∏è Configuraci√≥n</a>
      
      <a href="{% url 'lms:logout' %}">‚õî Cerrar sesi√≥n</a>

    </div>
  </div>

  <!-- LADO DERECHO -->
  <div>
    <!-- Panel: Cursos -->
    <div id="panel-cursos" class="card">
      <div class="header-row">
        <h3 id="mis-cursos" style="margin:0">Mis cursos</h3>
        <div class="tabs" id="tabs">
          <button class="tab active" data-filter="todos">Todos</button>
          <button class="tab" data-filter="en_progreso">En progreso</button>
          <button class="tab" data-filter="aprobado">Finalizados</button>
        </div>
      </div>

      {% if courses_data %}
        <div class="list" id="coursesList">
          {% for c in courses_data %}
            <div class="course-card course-item" data-status="{{ c.status }}">
              <div style="display:flex;align-items:center;justify-content:space-between;gap:12px">
                <div>
                  <strong>{{ c.course.title }}</strong>
                  <div class="muted">{{ c.passed }}/{{ c.total }} etapas aprobadas</div>

                  <div style="margin-top:8px;display:flex;flex-wrap:wrap;gap:8px">
                    {% for s in c.stages_info %}
                      <span class="chip {% if s.passed %}ok{% endif %}">
                        {% if s.passed %}‚úî{% else %}‚Ä¢{% endif %} {{ s.title }}
                      </span>
                    {% endfor %}
                  </div>
                </div>

                <div style="text-align:right">
                  {% if c.next_stage_url %}
                    <a class="btn" href="{{ c.next_stage_url }}">Continuar</a>
                  {% else %}
                    <span class="chip ok">Curso finalizado</span>
                  {% endif %}
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="empty">Todav√≠a no ten√©s cursos.</div>
      {% endif %}
    </div>

    <!-- Panel: Compras / Pedidos (arranca oculto) -->
    <div id="panel-pedidos" class="card hidden">
      <h3 id="pedidos" style="margin:0 0 12px">Mis compras</h3>
      {% if purchases %}
        <div class="list">
          {% for p in purchases %}
            <div class="course-card">
              <div style="display:flex;align-items:center;justify-content:space-between">
                <div>
                  <strong>#{{ p.id }}</strong> ‚Äî <span class="muted">{{ p.status }}</span> ‚Äî ${{ p.total_ars }}
                  <div class="muted">{{ p.created_at|date:"d/m/Y H:i" }}</div>
                </div>
              </div>
              <ul style="margin:10px 0 0 18px">
                {% for it in p.items.all %}
                  <li>
                    {% if it.stage %}
                      Etapa: {{ it.stage.title }}
                    {% elif it.bundle %}
                      Curso completo: {{ it.bundle.title }}
                    {% endif %}
                  </li>
                {% endfor %}
              </ul>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="empty muted">A√∫n no registramos compras.</div>
      {% endif %}
    </div>

    <!-- Panel: Configuraci√≥n (arranca oculto) -->
    <div id="panel-config" class="card hidden">
      <h3 id="config" style="margin:0 0 12px">Configuraci√≥n</h3>
      <form method="post">
        {% csrf_token %}
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
          <div>
            <label>Nombre</label>
            <input name="first_name" class="card" style="padding:10px;width:100%" value="{{ request.user.first_name }}">
          </div>
          <div>
            <label>Apellido</label>
            <input name="last_name" class="card" style="padding:10px;width:100%" value="{{ request.user.last_name }}">
          </div>
          <div style="grid-column:1 / -1">
            <label>Email</label>
            <input name="email" class="card" style="padding:10px;width:100%" value="{{ request.user.email }}">
          </div>
        </div>
        <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
          <button class="btn" type="submit">Guardar cambios</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  // --- Filtrado de cursos por tabs/KPI ---
  const list = document.getElementById('coursesList');
  const tabs = document.querySelectorAll('.tab');
  const kpis = document.querySelectorAll('.kpi');
  function applyFilter(f) {
    tabs.forEach(t => t.classList.toggle('active', t.dataset.filter === f));
    document.querySelectorAll('.course-item').forEach(li => {
      li.style.display = (f === 'todos' || li.dataset.status === f) ? '' : 'none';
    });
  }

  tabs.forEach(t => t.addEventListener('click', () => {
    showPanel('cursos'); // siempre muestra cursos al usar tabs
    applyFilter(t.dataset.filter);
    history.replaceState(null, '', '#mis-cursos');
  }));

  kpis.forEach(k => k.addEventListener('click', () => {
    const f = k.dataset.filter || 'todos';
    showPanel('cursos');
    applyFilter(f);
    history.replaceState(null, '', '#mis-cursos');
  }));

  // --- Mostrar/Ocultar paneles seg√∫n men√∫ lateral ---
  const sideLinks = document.querySelectorAll('.side-menu a[data-panel]');
  const panels = {
    cursos:  document.getElementById('panel-cursos'),
    pedidos: document.getElementById('panel-pedidos'),
    config:  document.getElementById('panel-config'),
  };
  function showPanel(name){
    Object.entries(panels).forEach(([key, el])=>{
      if(!el) return;
      el.classList.toggle('hidden', key !== name);
    });
    sideLinks.forEach(a => a.classList.toggle('active', a.dataset.panel === name));
  }

  sideLinks.forEach(a=>{
    a.addEventListener('click', (e)=>{
      // navegaci√≥n hash ok, pero gestionamos la UI ac√°:
      const panel = a.dataset.panel;
      showPanel(panel);
    });
  });

  // Hash inicial (#pedidos, #config, #mis-cursos)
  const hash = (location.hash || '').replace('#','');
  if (hash === 'pedidos') {
    showPanel('pedidos');
  } else if (hash === 'config') {
    showPanel('config');
  } else {
    showPanel('cursos');
  }

  // Filtro inicial por hash (opcional)
  if (hash === 'finalizados') applyFilter('aprobado');
  else if (hash === 'en-progreso') applyFilter('en_progreso');
  else applyFilter('todos');
</script>

{% endblock %}
